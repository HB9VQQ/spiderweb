var heatmap,COOKIE_PIN_EXPIRE=9999;function InitHeatmap(){var t={container:document.getElementById("heatmapArea"),radius:25,blur:.7,gradient:{.35:"rgb(0,0,255)",.5:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}};heatmap=h337.create(t)}function LoadHeatmap(t){heatmap.setData({max:20,min:0,data:[{x:1,y:1,count:0}]}),$("#heatmap-ajaxloader").removeClass("hidden"),$("#heatmapArea").addClass("loading"),$("#heatmapLegend").addClass("invisible"),fetch("heatmap?c="+t).then(t=>t.json()).then(e=>{try{b=e.length-1,e.splice(b,1),heatmap.setData({max:20,min:0,data:e}),$(".heatmap.loading").addClass("hidden"),$(".heatmap.head").removeClass("invisible"),$("#heatmapArea").removeClass("loading"),$("#heatmap-ajaxloader").addClass("hidden"),$("#heatmapLegendtext").text("Based on all reported Cluster Spots from/of "+$("#heatmapContinent :selected").text()+" during the last 60 minutes, shown by Continent and Band"),$("#heatmapLegend").removeClass("invisible")}catch(t){console.log(t),console.log(t.stack),console.log(e)}})}function UpdateHeatmap(t){fetch("heatmap?c="+t).then(t=>t.json()).then(e=>{try{b=e.length-1,e.splice(b,1),heatmap.setData({max:20,min:0,data:e})}catch(t){console.log(t),console.log(t.stack),console.log(e)}})}!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define(e):t.h337=e()}(this,function(){var d,n={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},r=(d=n.defaultRadius,t.prototype={_organiseData:function(t,e){var a=t[this._xField],i=t[this._yField],n=this._radi,r=this._data,s=this._max,h=this._min,o=t[this._valueField]||1,t=t.radius||this._cfgRadius||d;return r[a]||(r[a]=[],n[a]=[]),r[a][i]?r[a][i]+=o:(r[a][i]=o,n[a][i]=t),r[a][i]>s?(e?this.setDataMax(r[a][i]):this._max=r[a][i],!1):{x:a,y:i,value:o,radius:t,min:h,max:s}},_unOrganizeData:function(){var t,e=[],a=this._data,i=this._radi;for(t in a)for(var n in a[t])e.push({x:t,y:n,radius:i[t][n],value:a[t][n]});return{min:this._min,max:this._max,data:e}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(0<arguments[0].length)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var a=this._organiseData(arguments[0],!0);a&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[a]})}return this},setData:function(t){var e=t.data,a=e.length;this._data=[],this._radi=[];for(var i=0;i<a;i++)this._organiseData(e[i],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},t);function t(t){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)}function s(t){var e,a=t.gradient||t.defaultGradient,i=(t=document.createElement("canvas")).getContext("2d"),n=(t.width=256,t.height=1,i.createLinearGradient(0,0,256,1));for(e in a)n.addColorStop(e,a[e]);return i.fillStyle=n,i.fillRect(0,0,256,1),i.getImageData(0,0,256,1).data}function e(t){var e=t.container,a=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas||document.createElement("canvas"),n=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(t.container)||{});i.className="heatmap-canvas",this._width=i.width=a.width=t.width||+n.width.replace(/px/,""),this._height=i.height=a.height=t.height||+n.height.replace(/px/,""),this.shadowCtx=a.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=a.style.cssText="position:absolute;left:0;top:0;",e.style.position="relative",e.appendChild(i),this._palette=s(t),this._templates={},this._setStyles(t)}a=!(e.prototype={renderPartial:function(t){0<t.data.length&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),0<t.data.length&&(this._drawAlpha(function(t){for(var e=[],a=t.min,i=t.max,n=t.radi,t=t.data,r=Object.keys(t),s=r.length;s--;)for(var h=r[s],o=Object.keys(t[h]),d=o.length;d--;){var l=o[d],u=t[h][l],c=n[h][l];e.push({x:h,y:l,value:u,radius:c})}return{min:a,max:i,data:e}}(t)),this._colorize())},_updateGradient:function(t){this._palette=s(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var e,a,i,n,r,s=this._min=t.min,h=this._max=t.max,o=(t=t.data||[]).length,d=1-this._blur;o--;){var l,u=t[o],c=u.x,_=u.y,m=u.radius,u=Math.min(u.value,h),c=c-m,_=_-m,g=this.shadowCtx,p=(this._templates[m]?l=this._templates[m]:this._templates[m]=(e=m,a=d,r=p=n=i=void 0,i=document.createElement("canvas"),n=i.getContext("2d"),r=p=e,i.width=i.height=2*e,1==a?(n.beginPath(),n.arc(p,r,e,0,2*Math.PI,!1),n.fillStyle="rgba(0,0,0,1)",n.fill()):((a=n.createRadialGradient(p,r,e*a,p,r,e)).addColorStop(0,"rgba(0,0,0,1)"),a.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=a,n.fillRect(0,0,2*e,2*e)),l=i),(u-s)/(h-s));g.globalAlpha=p<.01?.01:p,g.drawImage(l,c,_),c<this._renderBoundaries[0]&&(this._renderBoundaries[0]=c),_<this._renderBoundaries[1]&&(this._renderBoundaries[1]=_),c+2*m>this._renderBoundaries[2]&&(this._renderBoundaries[2]=c+2*m),_+2*m>this._renderBoundaries[3]&&(this._renderBoundaries[3]=_+2*m)}},_colorize:function(){for(var t=this._renderBoundaries[0],e=this._renderBoundaries[1],a=this._renderBoundaries[2]-t,i=this._renderBoundaries[3]-e,n=this._width,r=this._height,s=this._opacity,h=this._maxOpacity,o=this._minOpacity,d=this._useGradientOpacity,n=this.shadowCtx.getImageData(t=t<0?0:t,e=e<0?0:e,a=n<t+a?n-t:a,i=r<e+i?r-e:i),l=n.data,u=l.length,c=this._palette,_=3;_<u;_+=4){var m=l[_],g=4*m;g&&(m=0<s?s:m<h?m<o?o:m:h,l[_-3]=c[g],l[_-2]=c[1+g],l[_-1]=c[2+g],l[_]=d?c[3+g]:m)}n.data=l,this.ctx.putImageData(n,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var t=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],e=this._max,a=this._min;return Math.abs(e-a)*(t/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}});var a,h,o=a="canvas2d"===n.defaultRenderer?e:a,l=function(){for(var t={},e=arguments.length,a=0;a<e;a++){var i,n=arguments[a];for(i in n)t[i]=n[i]}return t},i=(u.prototype={on:function(t,e,a){var i=this.cStore;i[t]||(i[t]=[]),i[t].push(function(t){return e.call(a,t)})},emit:function(t,e){var a=this.cStore;if(a[t])for(var i=a[t].length,n=0;n<i;n++)(0,a[t][n])(e)}},h=u,c.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=l(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},c);function u(){this.cStore={}}function c(){var e,t,a=this._config=l(n,arguments[0]||{});if(this._coordinator=new h,a.plugin){var i=a.plugin;if(!n.plugins[i])throw new Error("Plugin '"+i+"' not found. Maybe it was not registered.");var i=n.plugins[i];this._renderer=new i.renderer(a),this._store=new i.store(a)}else this._renderer=new o(a),this._store=new r(a);i=(e=this)._renderer,a=e._coordinator,t=e._store,a.on("renderpartial",i.renderPartial,i),a.on("renderall",i.renderAll,i),a.on("extremachange",function(t){e._config.onExtremaChange&&e._config.onExtremaChange({min:t.min,max:t.max,gradient:e._config.gradient||e._config.defaultGradient})}),t.setCoordinator(a)}return{create:function(t){return new i(t)},register:function(t,e){n.plugins[t]=e}}}),$(document).ready(function(){InitHeatmap(),Cookies.get("heatmapContinent")&&null!=Cookies.get("heatmapContinent")?(LoadHeatmap(Cookies.get("heatmapContinent")),$("#heatmapContinent").val(Cookies.get("heatmapContinent"))):LoadHeatmap("EU"),window.setInterval(function(){UpdateHeatmap($("#heatmapContinent").val())},6e4),$("#heatmapContinent").change(function(){LoadHeatmap($(this).val()),Cookies.set("heatmapContinent",$(this).val(),{expires:COOKIE_PIN_EXPIRE})})});
